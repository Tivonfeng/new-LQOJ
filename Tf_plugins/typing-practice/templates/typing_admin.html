{% extends "layout/basic.html" %}

{% block content %}
<div class="section typing-admin-page">
  <div class="section__header">
    <h1 class="section__title">
      <span class="icon">‚öôÔ∏è</span>
      {{ _('Typing Practice Admin') }}
    </h1>
    <div class="section__tools">
      <a href="/typing" class="btn btn-outline-primary">
        <span class="icon">‚å®Ô∏è</span>
        {{ _('Back to Practice') }}
      </a>
    </div>
  </div>

  <div class="typing-admin-container">
    <!-- Á≥ªÁªüÊ¶ÇËßà -->
    <div class="admin-overview">
      <div class="overview-card">
        <div class="card-icon">üë•</div>
        <div class="card-content">
          <div class="card-title">{{ _('Total Users') }}</div>
          <div class="card-value">{{ systemStats.totalUsers or 0 }}</div>
          <div class="card-subtitle">{{ systemStats.activeUsers or 0 }} {{ _('active') }}</div>
        </div>
      </div>

      <div class="overview-card">
        <div class="card-icon">üìù</div>
        <div class="card-content">
          <div class="card-title">{{ _('Total Practices') }}</div>
          <div class="card-value">{{ systemStats.totalPractices or 0 }}</div>
          <div class="card-subtitle">{{ systemStats.periodPractices or 0 }} {{ _('this period') }}</div>
        </div>
      </div>

      <div class="overview-card">
        <div class="card-icon">‚ö°</div>
        <div class="card-content">
          <div class="card-title">{{ _('Average WPM') }}</div>
          <div class="card-value">{{ systemStats.systemAvgWPM or 0 }}</div>
          <div class="card-subtitle">{{ _('system-wide') }}</div>
        </div>
      </div>

      <div class="overview-card">
        <div class="card-icon">üèÜ</div>
        <div class="card-content">
          <div class="card-title">{{ _('Top WPM') }}</div>
          <div class="card-value">{{ systemStats.topWPM or 0 }}</div>
          <div class="card-subtitle">{{ _('record') }}</div>
        </div>
      </div>

      <div class="overview-card">
        <div class="card-icon">üìä</div>
        <div class="card-content">
          <div class="card-title">{{ _('Activity Rate') }}</div>
          <div class="card-value">{{ systemStats.activityRate or 0 }}%</div>
          <div class="card-subtitle">{{ _('user engagement') }}</div>
        </div>
      </div>
    </div>

    <!-- ÁÆ°ÁêÜÂ∑•ÂÖ∑ -->
    <div class="admin-tools">
      <div class="tools-section">
        <h3>{{ _('System Management') }}</h3>
        <div class="tools-grid">
          <button id="cleanup-data-btn" class="tool-btn">
            <div class="tool-icon">üßπ</div>
            <div class="tool-title">{{ _('Cleanup Old Data') }}</div>
            <div class="tool-desc">{{ _('Remove old practice records') }}</div>
          </button>

          <button id="broadcast-message-btn" class="tool-btn">
            <div class="tool-icon">üì¢</div>
            <div class="tool-title">{{ _('Send Broadcast') }}</div>
            <div class="tool-desc">{{ _('Send message to all users') }}</div>
          </button>

          <button id="export-system-data-btn" class="tool-btn">
            <div class="tool-icon">üíæ</div>
            <div class="tool-title">{{ _('Export System Data') }}</div>
            <div class="tool-desc">{{ _('Download system statistics') }}</div>
          </button>

          <button id="refresh-stats-btn" class="tool-btn">
            <div class="tool-icon">üîÑ</div>
            <div class="tool-title">{{ _('Refresh Statistics') }}</div>
            <div class="tool-desc">{{ _('Update system statistics') }}</div>
          </button>
        </div>
      </div>

      <div class="tools-section">
        <h3>{{ _('User Management') }}</h3>
        <div class="user-management-tools">
          <div class="user-search">
            <input type="text" id="user-search-input" class="form-control" placeholder="{{ _('Search user by ID or username...') }}">
            <button id="search-user-btn" class="btn btn-primary">{{ _('Search') }}</button>
          </div>
          <div id="user-search-results" class="user-search-results" style="display: none;">
            <!-- ÊêúÁ¥¢ÁªìÊûúÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
          </div>
        </div>
      </div>
    </div>

    <!-- Ê¥ªË∑ÉÁî®Êà∑ÂàóË°® -->
    <div class="admin-section">
      <div class="section-header">
        <h3>{{ _('Recent Active Users') }}</h3>
        <div class="section-tools">
          <select id="active-users-period" class="form-control form-control-sm">
            <option value="1d">{{ _('Last 24 hours') }}</option>
            <option value="7d" selected>{{ _('Last 7 days') }}</option>
            <option value="30d">{{ _('Last 30 days') }}</option>
          </select>
        </div>
      </div>
      <div class="active-users-table">
        <table class="table">
          <thead>
            <tr>
              <th>{{ _('User') }}</th>
              <th>{{ _('Level') }}</th>
              <th>{{ _('Total Practices') }}</th>
              <th>{{ _('Best WPM') }}</th>
              <th>{{ _('Avg Accuracy') }}</th>
              <th>{{ _('Last Practice') }}</th>
              <th>{{ _('Actions') }}</th>
            </tr>
          </thead>
          <tbody>
            {% for user in activeUsers %}
            <tr>
              <td>
                <div class="user-info">
                  {% if user.avatar %}
                  <img src="{{ user.avatar }}" alt="{{ user.username }}" class="user-avatar">
                  {% endif %}
                  <div>
                    <div class="username">{{ user.username }}</div>
                    <div class="user-id">ID: {{ user.uid }}</div>
                  </div>
                </div>
              </td>
              <td>{{ user.level or 1 }}</td>
              <td>{{ user.totalPractices or 0 }}</td>
              <td>{{ user.bestWPM or 0 }}</td>
              <td>{{ (user.averageAccuracy or 0) | round(1) }}%</td>
              <td>
                {% if user.lastPracticeAt %}
                <span title="{{ user.lastPracticeAt }}">
                  {{ user.lastPracticeAt | date }}
                </span>
                {% else %}
                {{ _('Never') }}
                {% endif %}
              </td>
              <td>
                <div class="user-actions">
                  <button class="btn btn-sm btn-outline-primary view-user-stats" data-uid="{{ user.uid }}">
                    {{ _('View Stats') }}
                  </button>
                  <button class="btn btn-sm btn-outline-danger reset-user-data" data-uid="{{ user.uid }}" data-username="{{ user.username }}">
                    {{ _('Reset Data') }}
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- ÁªüËÆ°ÂõæË°® -->
    <div class="admin-section">
      <div class="section-header">
        <h3>{{ _('System Statistics') }}</h3>
        <div class="section-tools">
          <select id="stats-period" class="form-control form-control-sm">
            <option value="7d">{{ _('Last 7 days') }}</option>
            <option value="30d" selected>{{ _('Last 30 days') }}</option>
            <option value="90d">{{ _('Last 90 days') }}</option>
          </select>
        </div>
      </div>
      <div class="stats-charts-grid">
        <div class="chart-container">
          <h4>{{ _('Difficulty Distribution') }}</h4>
          <canvas id="difficulty-chart" width="400" height="300"></canvas>
        </div>
        <div class="chart-container">
          <h4>{{ _('Text Type Distribution') }}</h4>
          <canvas id="text-type-chart" width="400" height="300"></canvas>
        </div>
      </div>
    </div>

    <!-- ÊúÄËøëÊ¥ªÂä® -->
    <div class="admin-section">
      <div class="section-header">
        <h3>{{ _('Recent Activity') }}</h3>
      </div>
      <div class="recent-activity">
        <div class="activity-summary">
          <div class="summary-item">
            <span class="label">{{ _('Today') }}:</span>
            <span class="value">{{ recordsOverview.todayPractices }} {{ _('practices') }}</span>
            <span class="change {% if recordsOverview.dailyChange > 0 %}positive{% elif recordsOverview.dailyChange < 0 %}negative{% endif %}">
              ({% if recordsOverview.dailyChange >= 0 %}+{% endif %}{{ recordsOverview.dailyChange }})
            </span>
          </div>
          <div class="summary-item">
            <span class="label">{{ _('Yesterday') }}:</span>
            <span class="value">{{ recordsOverview.yesterdayPractices }} {{ _('practices') }}</span>
          </div>
          <div class="summary-item">
            <span class="label">{{ _('This Week') }}:</span>
            <span class="value">{{ recordsOverview.weekPractices }} {{ _('practices') }}</span>
          </div>
        </div>

        <div class="recent-practices-table">
          <h4>{{ _('Latest Practice Records') }}</h4>
          <table class="table table-sm">
            <thead>
              <tr>
                <th>{{ _('Time') }}</th>
                <th>{{ _('User') }}</th>
                <th>{{ _('WPM') }}</th>
                <th>{{ _('Accuracy') }}</th>
                <th>{{ _('Difficulty') }}</th>
                <th>{{ _('Score') }}</th>
              </tr>
            </thead>
            <tbody>
              {% for record in recordsOverview.recentPractices %}
              <tr>
                <td>{{ record.createdAt | date }}</td>
                <td>
                  <span class="user-link" data-uid="{{ record.uid }}">
                    User {{ record.uid }}
                  </span>
                </td>
                <td>{{ record.result.wpm }}</td>
                <td>{{ record.result.accuracy }}%</td>
                <td>
                  <span class="difficulty-badge difficulty-{{ record.result.difficulty }}">
                    {{ _(record.result.difficulty|title) }}
                  </span>
                </td>
                <td>{{ record.scoreEarned }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Êï∞ÊçÆÊ∏ÖÁêÜÊ®°ÊÄÅÊ°Ü -->
<div id="cleanup-modal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>{{ _('Cleanup Old Data') }}</h3>
      <button class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <div class="cleanup-options">
        <div class="form-group">
          <label for="cleanup-days">{{ _('Delete records older than') }}:</label>
          <select id="cleanup-days" class="form-control">
            <option value="30">30 {{ _('days') }}</option>
            <option value="60">60 {{ _('days') }}</option>
            <option value="90" selected>90 {{ _('days') }}</option>
            <option value="180">180 {{ _('days') }}</option>
            <option value="365">1 {{ _('year') }}</option>
          </select>
        </div>
        <div class="cleanup-warning">
          <strong>{{ _('Warning') }}:</strong> {{ _('This action cannot be undone. All practice records older than the specified period will be permanently deleted.') }}
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button id="confirm-cleanup" class="btn btn-danger">{{ _('Confirm Cleanup') }}</button>
      <button class="btn btn-secondary modal-close">{{ _('Cancel') }}</button>
    </div>
  </div>
</div>

<!-- ÂπøÊí≠Ê∂àÊÅØÊ®°ÊÄÅÊ°Ü -->
<div id="broadcast-modal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>{{ _('Send Broadcast Message') }}</h3>
      <button class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="broadcast-message">{{ _('Message') }}:</label>
        <textarea id="broadcast-message" class="form-control" rows="4" placeholder="{{ _('Enter your message here...') }}"></textarea>
      </div>
      <div class="form-group">
        <label for="broadcast-type">{{ _('Message Type') }}:</label>
        <select id="broadcast-type" class="form-control">
          <option value="info">{{ _('Information') }}</option>
          <option value="warning">{{ _('Warning') }}</option>
          <option value="success">{{ _('Success') }}</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button id="send-broadcast" class="btn btn-primary">{{ _('Send Message') }}</button>
      <button class="btn btn-secondary modal-close">{{ _('Cancel') }}</button>
    </div>
  </div>
</div>

<!-- Áî®Êà∑Êï∞ÊçÆÈáçÁΩÆÁ°ÆËÆ§Ê®°ÊÄÅÊ°Ü -->
<div id="reset-user-modal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>{{ _('Reset User Data') }}</h3>
      <button class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <div class="reset-warning">
        <p><strong>{{ _('Warning') }}:</strong> {{ _('You are about to reset all typing practice data for user') }} <span id="reset-username"></span> (ID: <span id="reset-uid"></span>).</p>
        <p>{{ _('This will permanently delete:') }}</p>
        <ul>
          <li>{{ _('All practice records') }}</li>
          <li>{{ _('User statistics') }}</li>
          <li>{{ _('Achievement progress') }}</li>
          <li>{{ _('Progress charts') }}</li>
        </ul>
        <p><strong>{{ _('This action cannot be undone.') }}</strong></p>
      </div>
    </div>
    <div class="modal-footer">
      <button id="confirm-reset-user" class="btn btn-danger">{{ _('Confirm Reset') }}</button>
      <button class="btn btn-secondary modal-close">{{ _('Cancel') }}</button>
    </div>
  </div>
</div>

<script>
// ‰º†ÈÄíÊï∞ÊçÆÂà∞ÂâçÁ´ØÁªÑ‰ª∂
window.TypingAdminData = {
  systemStats: {{ systemStats | dump | safe }},
  activeUsers: {{ activeUsers | dump | safe }},
  recordsOverview: {{ recordsOverview | dump | safe }},
  config: {{ config | dump | safe }}
};
</script>
{% endblock %}

{% block script %}
<!-- ÁÆ°ÁêÜÈ°µÈù¢ËÑöÊú¨‰ºöÂú®ËøôÈáåÂä†ËΩΩ -->
<div id="typing-admin-app-mount-point"></div>
{% endblock %}