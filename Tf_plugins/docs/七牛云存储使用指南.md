# 七牛云存储使用指南

## 概述

HydroOJ 系统集成了七牛云存储服务，用于处理文件上传、存储和管理。通过 `tf_plugins_core` 插件提供的 `QiniuCoreService`，各个业务插件可以方便地使用七牛云存储功能。

## 架构设计

```
tf_plugins_core (提供者)
    ↓ ctx.provide('qiniuCore', qiniuCore)
    ↓
业务插件 (消费者)
    ↓ ctx.inject(['qiniuCore'], callback)
    ↓
使用 QiniuCoreService 的方法
```

## QiniuCoreService 方法

### 文件上传

#### `uploadFile(filePath, prefix?)`
上传本地文件到七牛云

```typescript
const result = await qiniuCore.uploadFile('/path/to/file.jpg', 'certificates');
// 返回: { success: true, url: 'https://...', key: 'certificates/...', size: 1234 }
```

#### `uploadBuffer(buffer, filename, prefix?)`
上传Buffer数据到七牛云

```typescript
const buffer = Buffer.from('file content');
const result = await qiniuCore.uploadBuffer(buffer, 'document.pdf', 'docs');
// 返回: { success: true, url: 'https://...', key: 'docs/...', size: 1234 }
```

### 文件删除

#### `deleteFile(key)`
删除单个文件

```typescript
const result = await qiniuCore.deleteFile('certificates/user123/cert.jpg');
// 返回: { success: true } 或 { success: false, error: '...' }
```

#### `deleteMultiple(keys)`
批量删除文件

```typescript
const keys = ['cert1.jpg', 'cert2.jpg', 'cert3.jpg'];
const result = await qiniuCore.deleteMultiple(keys);
// 返回: { success: true } 或 { success: false, error: '...' }
```

### URL生成

#### `getFileUrl(key, expirySeconds?)`
获取文件访问URL（公开访问）

```typescript
const url = qiniuCore.getFileUrl('certificates/user123/cert.jpg');
// 返回: 'https://domain.com/certificates/user123/cert.jpg'
```

#### `getPrivateFileUrl(key, expirySeconds?)`
获取私有文件访问URL（带签名）

```typescript
const signedUrl = qiniuCore.getPrivateFileUrl('private/file.pdf', 3600);
// 返回: 带签名的私有访问URL，有效期1小时
```

### 工具方法

#### `generateCertificateKey(uid, certificateId, filetype?)`
生成证书文件的标准存储路径

```typescript
const key = qiniuCore.generateCertificateKey(123, 'CERT001', 'pdf');
// 返回: 'certificates/2024/01/user123/CERT001.pdf'
```

#### `isReady()`
检查服务是否已初始化

```typescript
if (qiniuCore.isReady()) {
    // 服务可用，可以进行上传操作
}
```

## 在插件中使用 QiniuCoreService

### 1. 服务获取方式

```typescript
// 在业务插件初始化时验证服务可用性
ctx.inject(['qiniuCore'], ({ qiniuCore }: any) => {
    if (qiniuCore) {
        console.log('✅ qiniuCore service available');
    }
});

// 在服务类中使用
const qiniuCore = await getQiniuCore(this.ctx);
```

### 2. 推荐的获取方式

```typescript
// 在服务类中创建获取方法
private getQiniuCore(): any {
    let qiniuCore: any = null;

    try {
        if (typeof this.ctx.inject === 'function') {
            this.ctx.inject(['qiniuCore'], ({ qiniuCore: _qc }: any) => {
                qiniuCore = _qc;
            });
        } else {
            qiniuCore = (this.ctx as any).qiniuCore;
        }
    } catch (e) {
        qiniuCore = (this.ctx as any).qiniuCore;
    }

    if (!qiniuCore) {
        throw new Error('QiniuCore service not available. Please ensure tf_plugins_core plugin is loaded.');
    }

    return qiniuCore;
}
```

### 3. 实际使用示例

#### 证书上传示例

```typescript
async uploadCertificate(filePath: string, uid: number, certificateId: string) {
    const qiniuCore = this.getQiniuCore();

    try {
        // 生成存储key
        const key = qiniuCore.generateCertificateKey(uid, certificateId, 'jpg');

        // 上传文件
        const result = await qiniuCore.uploadFile(filePath, 'certificates');

        if (result.success) {
            console.log(`证书上传成功: ${result.url}`);
            return {
                success: true,
                url: result.url,
                key: result.key,
                size: result.size
            };
        } else {
            console.error(`证书上传失败: ${result.error}`);
            return { success: false, error: result.error };
        }
    } catch (error) {
        console.error('证书上传异常:', error);
        return { success: false, error: error.message };
    }
}
```

#### 批量删除示例

```typescript
async deleteOldCertificates(certificateKeys: string[]) {
    const qiniuCore = this.getQiniuCore();

    try {
        const result = await qiniuCore.deleteMultiple(certificateKeys);

        if (result.success) {
            console.log(`成功删除 ${certificateKeys.length} 个证书文件`);
            return { success: true };
        } else {
            console.error(`删除失败: ${result.error}`);
            return { success: false, error: result.error };
        }
    } catch (error) {
        console.error('批量删除异常:', error);
        return { success: false, error: error.message };
    }
}
```

## 配置说明

### 七牛云配置（硬编码在服务中）

```typescript
// 七牛云凭证
QINIU_ACCESS_KEY: 'KLk2UkLXhUIzuoollr8iJmAn_Hc6AeELiAEDfZCZ'
QINIU_SECRET_KEY: 'SLeJSaHzxbfkgfwdemojwo9AH8mOxCFonDgZCxP0'

// 存储配置
QINIU_BUCKET: 'lq-exam-certificates'
QINIU_DOMAIN: 'lq-exam-cert.lqcode.fun'
QINIU_ZONE: 'Zone_z0'
```

### 文件限制

- 最大文件大小：10MB
- 支持的文件类型：任意（由业务层控制）
- 存储路径格式：`{prefix}/{year}/{month}/user{uid}/{filename}`

## 错误处理

### 常见错误及处理

#### 服务不可用
```typescript
throw new Error('QiniuCore service not available. Please ensure tf_plugins_core plugin is loaded before business plugins.');
```

#### 文件不存在
```typescript
return { success: false, error: '文件不存在: /path/to/file' };
```

#### 文件过大
```typescript
return { success: false, error: '文件大小超过10MB限制' };
```

#### 上传失败
```typescript
return { success: false, error: `上传失败: ${qiniuError.message}` };
```

## 最佳实践

1. **统一错误处理**：对所有QiniuCore调用进行try-catch处理
2. **文件大小检查**：在上传前检查文件大小，避免不必要的请求
3. **路径标准化**：使用`generateCertificateKey`生成标准化的存储路径
4. **批量操作**：对于多个文件的删除，使用`deleteMultiple`提高效率
5. **URL管理**：根据文件类型选择合适的URL生成方法

## 故障排除

### "QiniuCore service not available"
- 检查插件加载顺序：`tf_plugins_core` 应该在业务插件之前加载
- 检查插件配置确保 `tf_plugins_core` 已启用

### 上传失败
- 检查文件是否存在且可读
- 检查文件大小是否超过10MB
- 检查网络连接和七牛云服务状态

### 删除失败
- 检查文件key是否存在
- 检查删除权限和存储桶配置

### URL访问失败
- 检查域名配置是否正确
- 对于私有文件，确保使用`getPrivateFileUrl`生成带签名的URL
- 检查URL过期时间设置
