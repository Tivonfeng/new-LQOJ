# 积分系统使用指南

## 概述

HydroOJ 积分系统采用插件化架构设计，由两个核心插件组成：

- **`tf_plugins_core`**：提供核心积分服务 (ScoreCoreService)
- **`score-system`**：提供各种积分消费场景（游戏、签到、转账等）

## 架构设计

```
tf_plugins_core (提供者)
    ↓ ctx.provide('scoreCore', scoreCore)
    ↓
score-system (消费者)
    ↓ ctx.inject() → global.scoreCoreService
    ↓
游戏服务类 (Dice/RPS/Lottery/Transfer/CheckIn)
    ↓ 直接调用 ScoreCore 方法
```

## ScoreCore 服务方法

### 核心积分操作

#### `recordScoreChange(record)`
**推荐使用** - 同时记录积分变动历史并更新用户积分汇总

```typescript
await scoreCore.recordScoreChange({
    uid: 123,
    domainId: 'domain1',
    pid: 456,           // 题目ID或游戏ID
    recordId: 'game_789', // 关联记录ID
    score: 20,          // 积分变动值（正数增加，负数减少）
    reason: 'AC题目奖励',
    category: ScoreCategory.AC_PROBLEM,
    title: '两数之和'
});
```

#### `awardIfFirstAC(params)`
处理首次AC奖励，支持并发安全

```typescript
const result = await scoreCore.awardIfFirstAC({
    uid: 123,
    pid: 456,
    domainId: 'domain1',
    recordId: 'submission_789',
    score: 20,
    reason: '首次AC奖励',
    category: ScoreCategory.AC_PROBLEM,
    title: '两数之和'
});

console.log(`奖励 ${result.awarded} 积分，是否首次: ${result.isFirstAC}`);
```

### 查询操作

#### `getUserScore(domainId, uid)`
获取用户积分信息

```typescript
const userScore = await scoreCore.getUserScore('domain1', 123);
// 返回: { uid, totalScore, acCount, lastUpdated }
```

#### `getScoreRanking(domainId, limit)`
获取积分排行榜

```typescript
const ranking = await scoreCore.getScoreRanking('domain1', 10);
// 返回前10名用户积分信息
```

#### `getUserScoreStats(domainId, uid)`
获取用户详细统计信息

```typescript
const stats = await scoreCore.getUserScoreStats('domain1', 123);
// 返回: totalScore, rank, todayEarned, todaySpent, lastActivity, categoryBreakdown
```

### 批量操作

#### `batchAwardScores(userScores, reason, category)`
批量奖励积分

```typescript
const successCount = await scoreCore.batchAwardScores([
    { uid: 1, domainId: 'd1', amount: 100 },
    { uid: 2, domainId: 'd1', amount: 50 }
], '活动奖励', ScoreCategory.ADMIN_OPERATION);

console.log(`成功奖励 ${successCount} 个用户`);
```

#### `batchDeductScores(userScores, reason, category)`
批量扣除积分

```typescript
const successCount = await scoreCore.batchDeductScores([
    { uid: 1, domainId: 'd1', amount: 10 },
    { uid: 2, domainId: 'd1', amount: 20 }
], '违规处罚', ScoreCategory.ADMIN_OPERATION);
```

### 转账功能

#### `transferPoints(domainId, fromUid, toUid, amount, reason)`
积分转账（支持事务）

```typescript
await scoreCore.transferPoints('domain1', 123, 456, 50, '感谢帮助');
// 从用户123转账50积分给用户456
```

### 分页查询

#### `getScoreRankingWithPagination(domainId, page, limit)`
分页获取排行榜

```typescript
const result = await scoreCore.getScoreRankingWithPagination('domain1', 1, 20);
// 返回: { users, total, totalPages, currentPage, hasNext, hasPrev }
```

#### `getScoreRecordsWithPagination(domainId, page, limit, category?)`
分页获取积分记录

```typescript
const result = await scoreCore.getScoreRecordsWithPagination('domain1', 1, 10, ScoreCategory.GAME_ENTERTAINMENT);
// 返回指定分类的积分记录
```

### 统计功能

#### `getSystemScoreStats(domainId)`
获取系统整体统计

```typescript
const stats = await scoreCore.getSystemScoreStats('domain1');
// 返回: totalUsers, totalScore, todayActiveUsers, todayTotalScoreChange, topCategories
```

#### `getTodayStats(domainId)`
获取今日统计

```typescript
const todayStats = await scoreCore.getTodayStats('domain1');
// 返回: totalScore, activeUsers
```

### 缓存管理

#### `clearCache()`
清理所有缓存

```typescript
const result = scoreCore.clearCache();
// 返回: { userScoreCache: clearedCount, rankingCache: clearedCount }
```

#### `getCacheStatus()`
获取缓存状态

```typescript
const status = scoreCore.getCacheStatus();
// 返回缓存大小和状态信息
```

## 在插件中使用 ScoreCore

### 1. 服务获取方式

```typescript
// 在 score-system 插件初始化时
ctx.inject(['scoreCore'], ({ scoreCore }: any) => {
    (global as any).scoreCoreService = scoreCore;
});

// 在服务类中使用
const scoreCore = (global as any).scoreCoreService;
if (!scoreCore) {
    throw new Error('ScoreCore service not available');
}
```

### 2. 游戏积分消费示例

```typescript
async playDiceGame(domainId: string, uid: number, betAmount: number) {
    const scoreCore = (global as any).scoreCoreService;
    if (!scoreCore) {
        throw new Error('ScoreCore service not available');
    }

    // 1. 检查用户积分
    const userScore = await scoreCore.getUserScore(domainId, uid);
    if (!userScore || userScore.totalScore < betAmount) {
        return { success: false, message: '积分不足' };
    }

    // 2. 执行游戏逻辑
    const won = Math.random() > 0.5; // 简化逻辑
    const scoreChange = won ? betAmount : -betAmount;

    // 3. 记录积分变动
    await scoreCore.recordScoreChange({
        uid,
        domainId,
        pid: -1, // 游戏专用ID
        recordId: `dice_${Date.now()}`,
        score: scoreChange,
        reason: won ? '骰子游戏胜利' : '骰子游戏失败',
        category: ScoreCategory.GAME_ENTERTAINMENT,
        title: '骰子猜大小'
    });

    return { success: true, won, scoreChange };
}
```

### 3. 签到积分奖励示例

```typescript
async checkIn(domainId: string, uid: number) {
    const scoreCore = (global as any).scoreCoreService;
    if (!scoreCore) {
        throw new Error('ScoreCore service not available');
    }

    // 获取连续签到天数（业务逻辑）
    const streak = await this.getCheckInStreak(uid);
    const reward = this.calculateReward(streak);

    // 奖励积分
    await scoreCore.recordScoreChange({
        uid,
        domainId,
        pid: -10000000, // 签到专用ID范围
        recordId: `checkin_${Date.now()}`,
        score: reward,
        reason: `每日签到奖励 (连续${streak}天)`,
        category: ScoreCategory.DAILY_CHECKIN
    });

    return { success: true, reward, streak };
}
```

## 积分分类常量

```typescript
export const ScoreCategory = {
    AC_PROBLEM: 'AC题目',
    GAME_ENTERTAINMENT: '游戏娱乐',
    DAILY_CHECKIN: '每日签到',
    ADMIN_OPERATION: '管理员操作',
    TRANSFER: '积分转账'
} as const;
```

## 注意事项

### 1. 插件加载顺序
- 必须确保 `tf_plugins_core` 在 `score-system` 之前加载
- 如果顺序错误，会出现 "ScoreCore service not available" 错误

### 2. 错误处理
```typescript
try {
    await scoreCore.recordScoreChange(record);
} catch (error) {
    console.error('积分操作失败:', error);
    // 处理错误逻辑
}
```

### 3. 并发安全
- `awardIfFirstAC` 方法内部已处理并发安全
- 其他积分操作需要业务层保证数据一致性

### 4. 缓存机制
- ScoreCore 内部实现了用户积分和排行榜缓存
- 积分变动时会自动失效相关缓存
- 可以通过 `clearCache()` 手动清理缓存

### 5. 性能考虑
- 优先使用批量操作方法 (`batchAwardScores`, `batchDeductScores`)
- 合理使用分页查询避免一次性加载大量数据
- 理解缓存机制，减少不必要的缓存清理

## 最佳实践

1. **优先使用 `recordScoreChange`**：这是最安全和推荐的积分操作方法
2. **正确处理加载顺序**：确保 core 插件先加载
3. **添加完善的错误处理**：对所有 ScoreCore 调用进行错误处理
4. **合理使用缓存**：理解缓存机制，避免不必要的清理操作
5. **批量操作优先**：对于大量积分操作，使用批量方法提高性能
6. **选择合适的积分分类**：使用预定义的分类常量，便于统计和管理

## 故障排除

### "ScoreCore service not available"
- 检查插件加载顺序：`tf_plugins_core` 应该在 `score-system` 之前加载
- 检查配置文件确保两个插件都启用

### 积分操作失败
- 检查用户是否存在
- 检查积分是否足够（扣除操作）
- 检查数据库连接状态

### 缓存相关问题
- 某些查询结果不符合预期可能是缓存原因
- 可以调用 `clearCache()` 清理缓存后重试
- 检查缓存状态：`getCacheStatus()`
