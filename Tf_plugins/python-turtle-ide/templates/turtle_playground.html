{% extends "layout/basic.html" %}

{% block content %}
<div id="turtle-playground-app"></div>

<!-- 数据传递给前端 -->
<script id="turtle-data" type="application/json">
{
    "work": {{ workJSON | safe }},
    "userWorks": {{ userWorksJSON | safe }},
    "isLoggedIn": {{ 'true' if isLoggedIn else 'false' }},
    "currentUserId": {{ currentUserId if currentUserId else 'null' }},
    "currentUserName": {{ currentUserNameJSON | safe }},
    "task": {{ taskJSON | safe }},
    "taskProgress": {{ taskProgressJSON | safe }}
}
</script>

<!-- Skulpt 库加载 -->
<script>
(function() {
  // Skulpt 加载状态
  window.SkulptLoadingState = {
    loaded: false,
    failed: false,
    retryCount: 0,
    maxRetries: 3
  };

  function loadSkulpt() {
    if (window.SkulptLoadingState.loaded) return Promise.resolve();

    return new Promise((resolve, reject) => {
      // 尝试多个 CDN 源
      const cdnSources = [
        'https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt.min.js',
        'https://unpkg.com/skulpt@1.2.0/dist/skulpt.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/skulpt/1.2.0/skulpt.min.js'
      ];

      function tryNextCDN(index = 0) {
        if (index >= cdnSources.length) {
          window.SkulptLoadingState.failed = true;
          reject(new Error('所有 CDN 源都无法加载 Skulpt'));
          return;
        }

        const script = document.createElement('script');
        script.src = cdnSources[index];
        script.onload = function() {
          console.log('[Skulpt] Loaded from:', cdnSources[index]);
          window.SkulptLoadingState.loaded = true;

          // 加载 stdlib
          const stdlibScript = document.createElement('script');
          stdlibScript.src = cdnSources[index].replace('skulpt.min.js', 'skulpt-stdlib.js');
          stdlibScript.onload = function() {
            console.log('[Skulpt] Stdlib loaded');
            resolve();
          };
          stdlibScript.onerror = function() {
            console.warn('[Skulpt] Stdlib failed to load from:', cdnSources[index]);
            // stdlib 不是必需的，继续
            resolve();
          };
          document.head.appendChild(stdlibScript);
        };
        script.onerror = function() {
          console.warn('[Skulpt] Failed to load from:', cdnSources[index]);
          tryNextCDN(index + 1);
        };
        document.head.appendChild(script);
      }

      tryNextCDN();
    });
  }

  // 页面加载完成后开始加载 Skulpt
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadSkulpt);
  } else {
    loadSkulpt();
  }

  // 暴露加载状态检查函数
  window.checkSkulptLoaded = function() {
    return window.SkulptLoadingState.loaded && typeof window.Sk === 'object';
  };
})();
</script>

{% endblock %}
