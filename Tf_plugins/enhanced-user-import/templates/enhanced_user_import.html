{% extends "manage_base.html" %}
{% block manage_content %}
<div class="section">
  <div class="section__header">
    <h1 class="section__title">{{ _('Enhanced User Import') }}</h1>
  </div>
  <div class="section__body">
    <div class="import-container">
      
      <!-- 操作选项卡 -->
      <div class="tab-container">
        <div class="tab-header">
          <div class="tab-item active" data-tab="manual">{{ _('Manual Input') }}</div>
          <div class="tab-item" data-tab="file">{{ _('File Upload') }}</div>
          <div class="tab-item" data-tab="template">{{ _('Download Template') }}</div>
        </div>
        
        <!-- 手动输入标签页 -->
        <div id="tab-manual" class="tab-content active">
          <div class="format-help">
            <h3>{{ _('Format Help') }}</h3>
            <p>{{ _('User data format') }}：</p>
            <ul>
              <li>{{ _('Each line should contain') }}：{{ _('email, username, password, displayName, extra') }}</li>
              <li>{{ _('Extra field can be JSON with group, school, studentId') }}</li>
            </ul>
            <div class="format-example">
              <h4>{{ _('Example') }}：</h4>
              <pre>{{ sampleCSV }}</pre>
            </div>
          </div>

          <form method="post" id="manualForm">
            <div class="form__item">
              <label for="users">{{ _('User Data') }}</label>
              <textarea name="users" id="users" rows="10" cols="80" placeholder="{{ _('Or paste user data below') }}">{{ users|join('\n') }}</textarea>
            </div>
            <input type="hidden" name="format" value="manual">
            <input type="hidden" name="fileContent" value="">
            <div class="form-options">
              <div class="form__item">
                <label for="batchSize">{{ _('Batch size') }}</label>
                <input type="number" name="batchSize" id="batchSize" value="50" min="1" max="1000">
                <small>{{ _('Import in batches of') }} N {{ _('users') }}</small>
              </div>
              <div class="form__item">
                <label>
                  <input type="checkbox" name="draft" value="true" checked>
                  {{ _('Preview only (do not import)') }}
                </label>
              </div>
            </div>
            <div class="form__actions">
              <button type="submit" class="button primary">{{ _('Preview Results') }}</button>
              <button type="button" class="button" onclick="submitImport()">{{ _('Import Now') }}</button>
            </div>
          </form>
        </div>
        
        <!-- 文件上传标签页 -->
        <div id="tab-file" class="tab-content">
          <div class="upload-section">
            <h3>{{ _('Upload CSV/TSV File') }}</h3>
            <p>{{ _('Supported formats: CSV, TSV') }}</p>
            <p>{{ _('File size limit: 5MB') }}</p>
            
            <div class="upload-area" id="uploadArea">
              <div class="upload-placeholder">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>{{ _('Drag and drop files here') }}</p>
                <p>{{ _('or click to browse') }}</p>
              </div>
              <input type="file" id="fileInput" accept=".csv,.tsv" style="display: none;">
            </div>
            
            <form method="post" id="fileForm" style="display: none;">
              <div class="form__item">
                <label for="fileFormat">{{ _('Data Format') }}</label>
                <select name="format" id="fileFormat">
                  <option value="csv">{{ _('CSV Format') }}</option>
                  <option value="tsv">{{ _('TSV Format') }}</option>
                </select>
              </div>
              <input type="hidden" name="users" value="">
              <input type="hidden" name="fileContent" id="fileContent">
              <div class="form-options">
                <div class="form__item">
                  <label for="fileBatchSize">{{ _('Batch size') }}</label>
                  <input type="number" name="batchSize" id="fileBatchSize" value="50" min="1" max="1000">
                </div>
                <div class="form__item">
                  <label>
                    <input type="checkbox" name="draft" value="true" checked>
                    {{ _('Preview only (do not import)') }}
                  </label>
                </div>
              </div>
              <div class="form__actions">
                <button type="submit" class="button primary">{{ _('Preview Results') }}</button>
                <button type="button" class="button" onclick="submitFileImport()">{{ _('Import Now') }}</button>
                <button type="button" class="button secondary" onclick="clearFile()">{{ _('Clear Data') }}</button>
              </div>
            </form>
          </div>
        </div>
        
        <!-- 模板下载标签页 -->
        <div id="tab-template" class="tab-content">
          <div class="template-section">
            <h3>{{ _('Download Template') }}</h3>
            <p>{{ _('Use CSV or TSV format for best results') }}</p>
            
            <div class="template-options">
              <div class="template-item">
                <h4>{{ _('CSV Template') }}</h4>
                <p>{{ _('Comma-separated values format') }}</p>
                <a href="/manage/userimport/template/csv" class="button primary" download>{{ _('Download Sample CSV') }}</a>
              </div>
              <div class="template-item">
                <h4>{{ _('TSV Template') }}</h4>
                <p>{{ _('Tab-separated values format') }}</p>
                <a href="/manage/userimport/template/tsv" class="button primary" download>{{ _('Download Sample TSV') }}</a>
              </div>
            </div>
            
            <div class="tips-section">
              <h4>{{ _('Tips') }}</h4>
              <ul>
                <li>{{ _('Use CSV or TSV format for best results') }}</li>
                <li>{{ _('Maximum 5MB file size') }}</li>
                <li>{{ _('Batch import for large datasets') }}</li>
                <li>{{ _('Preview before importing') }}</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- 验证结果 -->
      {% if messages %}
      <div class="validation-panel">
        <h3>{{ _('Validation Results') }}</h3>
        {% if statistics %}
        <div class="statistics-summary">
          <div class="stat-item valid">
            <span class="stat-label">{{ _('Valid Users') }}</span>
            <span class="stat-value">{{ statistics.valid }}</span>
          </div>
          <div class="stat-item invalid">
            <span class="stat-label">{{ _('Invalid Users') }}</span>
            <span class="stat-value">{{ statistics.invalid }}</span>
          </div>
          <div class="stat-item duplicates">
            <span class="stat-label">{{ _('Duplicates') }}</span>
            <span class="stat-value">{{ statistics.duplicates }}</span>
          </div>
          <div class="stat-item total">
            <span class="stat-label">{{ _('Total Users') }}</span>
            <span class="stat-value">{{ statistics.total }}</span>
          </div>
        </div>
        {% endif %}
        <div class="validation-messages">
          {% for message in messages %}
          <div class="validation-item">{{ message }}</div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- 预览结果 -->
      {% if users and users|length > 0 %}
      <div class="preview-panel">
        <h3>{{ _('Preview Results') }}</h3>
        <p>{{ _('Total Users') }}：{{ users|length }}</p>
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>#</th>
                <th>{{ _('Email') }}</th>
                <th>{{ _('Username') }}</th>
                <th>{{ _('Display Name') }}</th>
                <th>{{ _('Extra Info') }}</th>
              </tr>
            </thead>
            <tbody>
              {% for user in users %}
              <tr>
                <td>{{ loop.index }}</td>
                <td>{{ user.email }}</td>
                <td>{{ user.username }}</td>
                <td>{{ user.displayName or '-' }}</td>
                <td>
                  {% if user.school %}学校: {{ user.school }}{% endif %}
                  {% if user.studentId %}学号: {{ user.studentId }}{% endif %}
                  {% if user.group %}组: {{ user.group }}{% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}

      <!-- 导入成功 -->
      {% if imported %}
      <div class="success-panel">
        <h3>{{ _('Import completed!') }}</h3>
        <p>{{ _('Successfully imported {0} users.').format(users|length) }}</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
// 标签页切换
document.addEventListener('DOMContentLoaded', function() {
  const tabs = document.querySelectorAll('.tab-item');
  const contents = document.querySelectorAll('.tab-content');
  
  tabs.forEach(tab => {
    tab.addEventListener('click', function() {
      const targetTab = this.dataset.tab;
      
      // 切换标签页状态
      tabs.forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      
      // 切换内容区域
      contents.forEach(content => {
        content.classList.remove('active');
        if (content.id === `tab-${targetTab}`) {
          content.classList.add('active');
        }
      });
    });
  });
  
  // 文件上传处理
  const uploadArea = document.getElementById('uploadArea');
  const fileInput = document.getElementById('fileInput');
  const fileForm = document.getElementById('fileForm');
  const fileContent = document.getElementById('fileContent');
  
  uploadArea.addEventListener('click', () => fileInput.click());
  
  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('drag-over');
  });
  
  uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('drag-over');
  });
  
  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      handleFile(files[0]);
    }
  });
  
  fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
      handleFile(e.target.files[0]);
    }
  });
  
  function handleFile(file) {
    if (file.size > 5 * 1024 * 1024) {
      alert('文件大小超过5MB限制');
      return;
    }
    
    if (!file.name.match(/\.(csv|tsv)$/)) {
      alert('仅支持CSV或TSV格式文件');
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
      fileContent.value = e.target.result;
      fileForm.style.display = 'block';
      uploadArea.innerHTML = `
        <div class="file-info">
          <i class="fas fa-file-alt"></i>
          <p>已选择文件: ${file.name}</p>
          <p>文件大小: ${(file.size / 1024).toFixed(2)} KB</p>
        </div>
      `;
      
      // 自动检测格式
      const format = file.name.toLowerCase().endsWith('.csv') ? 'csv' : 'tsv';
      document.getElementById('fileFormat').value = format;
    };
    reader.readAsText(file);
  }
});

// 提交函数
function submitImport() {
  const form = document.getElementById('manualForm');
  const draftCheckbox = form.querySelector('input[name="draft"]');
  draftCheckbox.checked = false;
  form.submit();
}

function submitFileImport() {
  const form = document.getElementById('fileForm');
  const draftCheckbox = form.querySelector('input[name="draft"]');
  draftCheckbox.checked = false;
  form.submit();
}

function clearFile() {
  const uploadArea = document.getElementById('uploadArea');
  const fileForm = document.getElementById('fileForm');
  const fileInput = document.getElementById('fileInput');
  
  uploadArea.innerHTML = `
    <div class="upload-placeholder">
      <i class="fas fa-cloud-upload-alt"></i>
      <p>{{ _('Drag and drop files here') }}</p>
      <p>{{ _('or click to browse') }}</p>
    </div>
  `;
  fileForm.style.display = 'none';
  fileInput.value = '';
}
</script>

<style>
.import-container {
    max-width: 1200px;
    margin: 0 auto;
}

.tab-container {
    background: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    margin-bottom: 20px;
    overflow: hidden;
}

.tab-header {
    display: flex;
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
}

.tab-item {
    flex: 1;
    padding: 15px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    color: #6c757d;
}

.tab-item:hover {
    background: #e9ecef;
}

.tab-item.active {
    background: #007bff;
    color: white;
}

.tab-content {
    display: none;
    padding: 20px;
}

.tab-content.active {
    display: block;
}

.format-help {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.format-example {
    background: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 15px;
    margin: 10px 0;
}

.format-example pre {
    font-family: 'Courier New', monospace;
    font-size: 14px;
    margin: 0;
    white-space: pre-wrap;
}

.form-options {
    display: flex;
    gap: 20px;
    margin: 20px 0;
}

.form-options .form__item {
    flex: 1;
}

.upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 40px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 20px;
}

.upload-area:hover {
    border-color: #007bff;
    background: #f8f9ff;
}

.upload-area.drag-over {
    border-color: #007bff;
    background: #e3f2fd;
}

.upload-placeholder i {
    font-size: 48px;
    color: #6c757d;
    margin-bottom: 15px;
}

.file-info {
    color: #28a745;
}

.file-info i {
    font-size: 48px;
    margin-bottom: 15px;
}

.template-options {
    display: flex;
    gap: 20px;
    margin: 20px 0;
}

.template-item {
    flex: 1;
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
}

.statistics-summary {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.stat-item {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    flex: 1;
    min-width: 120px;
}

.stat-item.valid {
    background: #d4edda;
    color: #155724;
}

.stat-item.invalid {
    background: #f8d7da;
    color: #721c24;
}

.stat-item.duplicates {
    background: #fff3cd;
    color: #856404;
}

.stat-item.total {
    background: #d1ecf1;
    color: #0c5460;
}

.stat-label {
    display: block;
    font-size: 12px;
    font-weight: 500;
    margin-bottom: 5px;
}

.stat-value {
    display: block;
    font-size: 24px;
    font-weight: bold;
}

.validation-panel {
    background: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.validation-item {
    padding: 8px 12px;
    margin: 5px 0;
    border-radius: 4px;
    font-size: 14px;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
}

.preview-panel {
    background: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.table-container {
    overflow-x: auto;
    margin-top: 15px;
}

.success-panel {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    color: #155724;
}

.form__actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.table {
    width: 100%;
    border-collapse: collapse;
}

.table th,
.table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e9ecef;
}

.table th {
    background: #f8f9fa;
    font-weight: 600;
    position: sticky;
    top: 0;
}

.table tbody tr:hover {
    background: #f8f9fa;
}

.tips-section {
    background: #e3f2fd;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
}

.tips-section ul {
    margin: 10px 0;
    padding-left: 20px;
}

.tips-section li {
    margin: 5px 0;
}

@media (max-width: 768px) {
    .form-options {
        flex-direction: column;
    }
    
    .template-options {
        flex-direction: column;
    }
    
    .statistics-summary {
        flex-direction: column;
    }
    
    .stat-item {
        min-width: auto;
    }
}
</style>
{% endblock %} 