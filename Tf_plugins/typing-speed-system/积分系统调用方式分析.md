# Typing Speed System 插件 - 积分系统调用方式分析

## 当前实现方式

`typing-speed-system` 插件通过**直接操作数据库集合**的方式来调用积分系统，而不是通过服务层或事件系统。

### 实现位置

主要在以下文件中：
- `src/handlers/TypingHallHandlers.ts` (第 119-137 行)
- `src/handlers/TypingAdminHandlers.ts` (第 119-137 行, 第 228-245 行)

### 具体实现代码

```typescript
// 添加积分记录
await this.ctx.db.collection('score.records' as any).insertOne({
    uid: user._id,
    domainId: this.domain._id,
    pid: 0,
    recordId: null,
    score: bonus.bonus,
    reason: bonus.reason,
    createdAt: new Date(),
});

// 更新用户积分
await this.ctx.db.collection('score.users' as any).updateOne(
    { uid: user._id },
    {
        $inc: { totalScore: bonus.bonus },
        $set: { lastUpdated: new Date() },
    },
    { upsert: true },
);
```

## 当前方式的特点

### 优点
1. **简单直接**：不需要导入其他插件的代码
2. **性能可控**：直接操作数据库，没有额外的服务层开销
3. **独立性强**：不依赖 score-system 插件是否加载

### 缺点
1. **绕过业务逻辑**：直接操作数据库，绕过了 ScoreService 的业务逻辑
2. **数据一致性风险**：如果积分系统的数据结构改变，这个插件可能会出问题
3. **维护成本高**：需要手动维护积分记录的格式和用户积分的更新逻辑
4. **代码重复**：积分更新逻辑在多个地方重复实现
5. **类型安全差**：使用 `as any` 绕过类型检查

## 改进方案

### 方案一：使用事件系统（推荐，与 exam-hall 一致）

**优点**：
- 完全解耦，两个插件互不依赖
- 符合 HydroOJ 插件系统设计理念
- 易于扩展和维护

**实现方式**：

1. **在 typing-speed-system 中触发事件**：

```typescript
// 触发打字奖励事件
this.ctx.emit('typing/bonus-awarded', {
    uid: user._id,
    domainId: this.domain._id,
    bonus: bonus.bonus,
    reason: bonus.reason,
    bonusType: bonus.type, // 'progress' | 'level' | 'surpass'
    recordId: recordId,
});
```

2. **在 score-system 中监听事件**：

```typescript
// score-system/index.ts
ctx.on('typing/bonus-awarded', async (data) => {
    if (!finalConfig.enabled) return;
    
    const scoreService = new ScoreService(finalConfig, ctx);
    await scoreService.updateUserScore(data.domainId, data.uid, data.bonus);
    await scoreService.addScoreRecord({
        uid: data.uid,
        domainId: data.domainId,
        pid: 0,
        recordId: data.recordId,
        score: data.bonus,
        reason: data.reason,
    });
});
```

### 方案二：直接导入 ScoreService（如果两个插件总是同时使用）

**优点**：
- TypeScript 类型支持完整
- 编译时检查
- 可以使用 ScoreService 的所有功能

**缺点**：
- 两个插件产生直接依赖
- 如果 score-system 未加载，typing-speed-system 会报错

**实现方式**：

```typescript
// 导入积分服务
import { ScoreService } from '../../score-system/src/services/ScoreService';

// 使用
const scoreService = new ScoreService({ enabled: true }, this.ctx);
await scoreService.updateUserScore(domainId, uid, bonus);
await scoreService.addScoreRecord({
    uid,
    domainId,
    pid: 0,
    recordId,
    score: bonus,
    reason,
});
```

### 方案三：通过 ctx.provide() 提供服务（如果 score-system 需要被多个插件使用）

**优点**：
- 解耦，插件可以独立加载
- 运行时检查服务是否可用

**缺点**：
- 需要确保服务提供方先加载
- 需要处理服务不存在的情况

**实现方式**：

```typescript
// score-system/index.ts
ctx.provide('scoreService', scoreService);

// typing-speed-system 中使用
if (this.ctx.scoreService) {
    await this.ctx.scoreService.updateUserScore(domainId, uid, bonus);
}
```

## 推荐改进

**建议采用方案一（事件系统）**，原因：

1. **与 exam-hall 保持一致**：exam-hall 已经使用事件系统，保持统一的调用方式
2. **完全解耦**：typing-speed-system 和 score-system 互不依赖
3. **易于扩展**：其他插件也可以监听打字奖励事件
4. **符合最佳实践**：符合 HydroOJ 插件系统的设计理念

## 当前实现的问题

1. **数据格式不一致**：直接操作数据库时，`recordId` 设置为 `null`，而 exam-hall 使用证书 ID
2. **缺少错误处理**：直接操作数据库，如果积分系统未加载，不会报错，但数据可能不一致
3. **维护困难**：如果积分系统的数据结构改变，需要手动更新多个地方

## 总结

当前 typing-speed-system 插件使用**直接操作数据库集合**的方式调用积分系统，这种方式虽然简单，但不是最佳实践。建议改为**事件系统**，与 exam-hall 插件保持一致，提高代码的可维护性和扩展性。

