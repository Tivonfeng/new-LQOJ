# 全局赛考权重系统分析

## 📋 系统概述

赛考权重系统是一个基于多维度自动计算证书权重的系统，用于：
- **自动计算证书权重**：根据证书的级别、奖项、类型等维度自动计算权重值
- **积分关联**：证书权重直接等于获得的积分数量
- **排行榜排序**：基于用户所有证书的总权重（赛考指数）进行排行榜排序

---

## 🏗️ 系统架构

### 1. 核心服务

#### `WeightCalculationService` (权重计算服务)
**位置**: `src/services/WeightCalculationService.ts`

**职责**:
- 提供权重计算的核心算法
- 管理权重配置
- 支持批量计算和预览

**关键方法**:
- `calculateCertificateWeight()`: 计算单个证书权重
- `batchCalculateWeights()`: 批量计算证书权重
- `previewWeight()`: 预览权重计算结果（不保存）
- `getConfig()` / `updateConfig()`: 获取/更新权重配置

---

## 📊 权重计算规则

### 计算公式

```
最终权重 = 基础权重 × 级别系数 × 奖项系数 × 类型系数
```

### 权重配置（默认值）

#### 1. 基础权重
- **值**: `10分`
- **说明**: 所有证书的起始权重

#### 2. 级别系数（50%权重）
| 级别 | 系数 | 说明 |
|------|------|------|
| 市级 (city) | 1.0 | 基础权重 |
| 省级 (province) | 2.0 | +100% |
| 国家级 (national) | 4.0 | +300% |

#### 3. 奖项系数（40%权重）

**竞赛类型**:
| 奖项 | 系数 |
|------|------|
| 一等奖 | 2.0 |
| 二等奖 | 1.6 |
| 三等奖 | 1.3 |
| 优秀奖 | 1.0 |

**考级类型**:
| 奖项 | 系数 |
|------|------|
| 通过 | 1.2 |

#### 4. 类型系数（10%权重）
| 类型 | 系数 | 说明 |
|------|------|------|
| 竞赛 (competition) | 1.0 | 竞赛基础权重 |
| 考级 (certification) | 0.5 | 考级基础权重（降低，因为考级通过不能和竞赛获奖相提并论） |

### 权重范围

**竞赛证书**:
- **最小值**: 10分（市级优秀奖）
- **最大值**: 80分（国家级一等奖）
- **计算公式**: `10 × 4.0 × 2.0 × 1.0 = 80分`

**考级证书**:
- **最小值**: 5分（市级通过）
- **最大值**: 24分（国家级通过）
- **计算公式**: `10 × 4.0 × 1.2 × 0.5 = 24分`

**说明**: 考级证书的类型系数降低为0.5，确保即使国家级考级通过也不能和竞赛国家一等奖相提并论。

### 计算示例

**示例1: 国家级一等奖**
```
基础权重: 10分
级别系数: ×4.0 (国家级)
奖项系数: ×2.0 (一等奖)
类型系数: ×1.0 (竞赛)
最终权重 = 10 × 4.0 × 2.0 × 1.0 = 80.0分
```

**示例2: 省级二等奖**
```
基础权重: 10分
级别系数: ×2.0 (省级)
奖项系数: ×1.6 (二等奖)
类型系数: ×1.0 (竞赛)
最终权重 = 10 × 2.0 × 1.6 × 1.0 = 32.0分
```

**示例3: 市级考级通过**
```
基础权重: 10分
级别系数: ×1.0 (市级)
奖项系数: ×1.2 (通过)
类型系数: ×0.5 (考级，降低权重)
最终权重 = 10 × 1.0 × 1.2 × 0.5 = 6.0分
```

**示例4: 国家级考级通过**
```
基础权重: 10分
级别系数: ×4.0 (国家级)
奖项系数: ×1.2 (通过)
类型系数: ×0.5 (考级，降低权重)
最终权重 = 10 × 4.0 × 1.2 × 0.5 = 24.0分
```

**对比**: 国家级考级通过(24分) < 国家级竞赛一等奖(80分)，差距明显

---

## 🔄 数据流程

### 1. 证书创建流程

```
创建证书
  ↓
自动计算权重 (WeightCalculationService.calculateCertificateWeight)
  ↓
保存 calculatedWeight 和 weightBreakdown
  ↓
更新用户统计 (CertificateService.updateUserStats)
  ↓
触发积分事件 (certificate/created)
  ↓
积分系统增加积分 (积分 = 权重)
```

### 2. 用户统计更新流程

```
updateUserStats(uid)
  ↓
查询用户所有证书 (exam.certificates)
  ↓
分类统计:
  - 竞赛证书: competitionStats.weight
  - 考级证书: certificationStats.weight
  ↓
计算总权重: totalWeight = competitionWeight + certificationWeight
  ↓
更新/插入用户统计 (exam.user_stats)
```

### 3. 排行榜查询流程

```
getLeaderboard(limit)
  ↓
查询用户统计 (exam.user_stats)
  ↓
按 totalWeight 降序排序
  ↓
返回前 N 名用户
```

---

## 💾 数据存储

### 1. 证书表 (exam.certificates)

**权重相关字段**:
```typescript
{
  calculatedWeight: number,      // 计算得出的权重值（优先使用）
  weight: number,                // 旧权重值（向后兼容）
  weightBreakdown: {             // 权重计算详情
    baseWeight: number,          // 基础权重
    levelFactor: number,         // 级别系数
    awardFactor: number,         // 奖项系数
    typeFactor: number,          // 类型系数
    calculation: string          // 计算过程说明
  }
}
```

### 2. 用户统计表 (exam.user_stats)

**权重相关字段**:
```typescript
{
  uid: number,
  domainId: ObjectId,
  totalWeight: number,           // 总权重（赛考指数）
  competitionStats: {
    total: number,               // 竞赛证书数量
    weight: number,              // 竞赛证书总权重
    competitions: Record<string, number>  // 按竞赛名统计
  },
  certificationStats: {
    total: number,               // 考级证书数量
    weight: number,              // 考级证书总权重
    series: Record<string, { count: number }>  // 按系列统计
  }
}
```

---

## 🔌 API 接口

### 1. 权重配置管理

**GET** `/exam/admin/weight-config`
- 获取当前权重配置

**PUT** `/exam/admin/weight-config`
- 更新权重配置
- 需要管理员权限

### 2. 权重预览

**POST** `/exam/admin/weight-preview`
- 预览权重计算结果（不保存）
- 参数: `{ examType, level, awardLevel }`

### 3. 批量重新计算

**POST** `/exam/admin/recalculate-weights`
- 重新计算所有证书或指定证书的权重
- 参数: `{ certificateIds?, recalculateAll? }`
- 自动更新用户统计

### 4. 权重统计

**GET** `/exam/admin/weight-stats`
- 获取权重分布统计
- 包括: 权重分布、级别统计、类型统计

---

## 🔗 与积分系统的集成

### 事件机制

**证书创建事件** (`certificate/created`):
```typescript
{
  uid: number,
  domainId: string,
  certificateId: ObjectId,
  weight: number,              // 证书权重
  certificateName: string
}
```

**证书删除事件** (`certificate/deleted`):
```typescript
{
  uid: number,
  domainId: string,
  certificateId: ObjectId,
  weight: number,              // 证书权重（用于减少积分）
  certificateName: string
}
```

### 积分计算规则

- **积分 = 权重**
- 创建证书时: 积分 += 权重
- 删除证书时: 积分 -= 权重
- 更新证书时: 先减少旧权重，再增加新权重

---

## 📈 排行榜系统

### 赛考指数排行榜

**排序依据**: `totalWeight` (总权重)

**数据来源**: `exam.user_stats` 表

**显示内容**:
- 排名
- 用户信息（用户名、displayName、头像）
- 证书总数
- 竞赛权重
- 考级权重
- 总指数（totalWeight）

**查询优化**:
- 使用 MongoDB 索引加速排序
- 支持分页查询
- 支持跨域查询（可选）

---

## ⚙️ 配置管理

### 权重配置结构

```typescript
interface WeightConfig {
  levelWeights: Record<Level, number>,      // 级别权重系数
  awardWeights: {                           // 奖项权重系数
    competition: Record<string, number>,
    certification: Record<string, number>
  },
  examTypeWeights: {                        // 类型权重系数
    competition: number,
    certification: number
  },
  baseWeight: number                        // 基础权重
}
```

### 配置更新

- 配置存储在内存中（服务实例级别）
- 可通过 API 动态更新
- 更新后需要重新计算证书权重才能生效

---

## 🔍 关键特性

### 1. 自动计算
- 证书创建/更新时自动计算权重
- 无需手动设置

### 2. 向后兼容
- 支持旧的 `weight` 字段
- 优先使用 `calculatedWeight`

### 3. 批量处理
- 支持批量重新计算权重
- 使用 Promise.all 并发更新

### 4. 统计优化
- 使用 MongoDB 投影减少数据传输
- 缓存用户统计结果
- 按需更新统计

### 5. 计算详情
- 保存完整的计算过程
- 支持查看权重计算详情

---

## 🐛 潜在问题与优化建议

### 1. 配置持久化
**问题**: 权重配置存储在内存中，服务重启后丢失

**建议**: 
- 将配置存储到数据库
- 或使用配置文件

### 2. 权重统计优化
**问题**: `WeightStatsHandler` 中的级别统计未正确实现

**建议**: 
- 从预设中获取级别信息
- 完善级别统计逻辑

### 3. 性能优化
**问题**: 批量重新计算时可能影响性能

**建议**: 
- 添加进度跟踪
- 支持分批处理
- 添加后台任务队列

### 4. 权重验证
**问题**: 缺少权重值的合理性验证

**建议**: 
- 添加权重范围检查
- 添加异常值检测

---

## 📝 总结

全局赛考权重系统是一个**自动化、多维度、可配置**的权重计算系统，通过以下方式实现：

1. **多维度计算**: 级别、奖项、类型三个维度
2. **自动更新**: 证书创建/更新时自动计算和更新
3. **积分关联**: 权重直接等于积分
4. **排行榜支持**: 基于总权重排序
5. **灵活配置**: 支持动态调整权重配置

系统设计合理，具有良好的扩展性和可维护性。

