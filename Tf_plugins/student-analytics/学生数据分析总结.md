# Hydro 系统学生数据分析总结

基于 [Hydro 数据库结构文档](https://hydro.js.org/docs/Hydro/dev/db-layout) 和代码分析，总结可以从 Hydro 系统中提炼的学生数据。

## 一、提交记录数据 (record 集合)

### 1.1 基础提交信息
- **用户标识**: `uid` - 用户ID
- **题目标识**: `pid` - 题目ID
- **域标识**: `domainId` - 域ID
- **提交时间**: `_id` (ObjectId 包含时间戳) 或 `judgeAt` - 判题时间
- **语言**: `lang` - 编程语言
- **代码长度**: `code.length` - 代码字符数
- **代码内容**: `code` - 提交的代码（可选，用于代码质量分析）

### 1.2 判题结果信息
- **状态**: `status` - 判题状态（AC, WA, TLE, MLE, RE, CE 等）
- **分数**: `score` - 得分（0-100）
- **运行时间**: `time` - 运行时间（毫秒）
- **内存使用**: `memory` - 内存使用（KB）
- **测试用例**: `testCases` - 各测试用例的详细结果
- **编译信息**: `compilerTexts` - 编译输出
- **判题信息**: `judgeTexts` - 判题输出

### 1.3 上下文信息
- **比赛关联**: `contest` - 是否在比赛中提交
- **重判标记**: `rejudged` - 是否被重判
- **来源**: `source` - 提交来源
- **进度**: `progress` - 判题进度

### 可提炼的数据指标：
- ✅ 提交总数
- ✅ AC 题目数
- ✅ 各状态提交分布（WA, TLE, MLE, RE, CE 等）
- ✅ 平均提交次数/题目
- ✅ 首次 AC 时间
- ✅ **代码行数统计**（总行数、每周行数、平均行数等）
- ✅ 代码质量指标（代码长度、复杂度等）
- ✅ 语言使用偏好
- ✅ 提交时间分布（按小时、按天、按周）
- ✅ 比赛参与度

---

## 二、题目状态数据 (document.status 集合 - ProblemStatusDoc)

### 2.1 题目完成状态
- **题目ID**: `docId` - 题目ID
- **用户ID**: `uid` - 用户ID
- **域ID**: `domainId` - 域ID
- **最佳记录ID**: `rid` - 最佳提交记录ID
- **最高分数**: `score` - 该题目的最高得分
- **状态**: `status` - 题目状态
- **收藏标记**: `star` - 是否收藏

### 可提炼的数据指标：
- ✅ 已解决题目数
- ✅ 已尝试题目数
- ✅ 题目完成率
- ✅ 收藏题目数
- ✅ 题目难度分布
- ✅ 题目标签分布

---

## 三、题目统计数据 (record.stat 集合 - RecordStatDoc)

### 3.1 最佳记录统计
- **题目ID**: `pid`
- **用户ID**: `uid`
- **域ID**: `domainId`
- **最佳时间**: `time` - 最佳运行时间
- **最佳内存**: `memory` - 最佳内存使用
- **代码长度**: `length` - 代码长度
- **语言**: `lang` - 使用的语言

### 可提炼的数据指标：
- ✅ 平均运行时间
- ✅ 平均内存使用
- ✅ 代码效率指标
- ✅ 语言性能对比

---

## 四、题目信息数据 (document 集合 - ProblemDoc)

### 4.1 题目元数据
- **题目ID**: `docId`, `pid`
- **标题**: `title`
- **标签**: `tag[]` - 题目标签数组
- **难度**: `difficulty` - 题目难度
- **提交数**: `nSubmit` - 总提交次数
- **通过数**: `nAccept` - 总通过次数
- **统计信息**: `stats` - 详细统计信息

### 可提炼的数据指标：
- ✅ 题目难度分布
- ✅ 题目标签偏好
- ✅ 题目通过率
- ✅ 题目热度分析

---

## 五、比赛数据 (document 集合 - Tdoc)

### 5.1 比赛参与信息
- **比赛ID**: `docId`
- **标题**: `title`
- **开始时间**: `beginAt`
- **结束时间**: `endAt`
- **参与人数**: `attend`
- **题目列表**: `pids[]`
- **规则**: `rule` - 比赛规则（ACM, OI 等）
- **是否计分**: `rated`

### 5.2 比赛状态 (document.status)
- 比赛中的提交记录
- 比赛排名
- 比赛得分

### 可提炼的数据指标：
- ✅ 比赛参与次数
- ✅ 比赛完成率
- ✅ 比赛排名分布
- ✅ 比赛类型偏好（ACM, OI）
- ✅ 比赛时间段分析

---

## 六、训练数据 (document 集合 - TrainingDoc)

### 6.1 训练参与信息
- **训练ID**: `docId`
- **标题**: `title`
- **描述**: `description`
- **DAG结构**: `dag[]` - 训练依赖图
- **题目列表**: `dag[].pids[]`

### 6.2 训练状态 (document.status)
- 训练完成进度
- 训练节点完成情况

### 可提炼的数据指标：
- ✅ 训练参与数
- ✅ 训练完成度
- ✅ 训练路径分析
- ✅ 知识点掌握情况

---

## 七、用户行为数据 (oplog 集合)

### 7.1 操作日志
- **操作类型**: `type` - 操作类型
- **操作时间**: `time` - 操作时间
- **操作路径**: `path` - 访问路径
- **操作者**: `operator` - 用户ID
- **操作IP**: `operateIp` - IP地址
- **用户代理**: `ua` - User-Agent
- **引用来源**: `referer` - 来源页面
- **参数**: `args` - 操作参数

### 可提炼的数据指标：
- ✅ 访问频率
- ✅ 访问时间段分布
- ✅ 页面访问路径
- ✅ 功能使用偏好
- ✅ 在线时长估算
- ✅ 活跃度指标

---

## 八、访问频率数据 (opcount 集合)

### 8.1 操作计数
- **操作类型**: `op` - 操作类型
- **标识**: `ident` - 用户标识（通常是 uid）
- **计数**: `opcount` - 操作次数
- **过期时间**: `expireAt` - 过期时间

### 可提炼的数据指标：
- ✅ 操作频率分析
- ✅ 功能使用频率
- ✅ 活跃度趋势

---

## 九、用户基础信息 (user 集合)

### 9.1 用户元数据
- **用户ID**: `_id`
- **用户名**: `uname`
- **邮箱**: `mail`
- **注册时间**: `regat`
- **最后登录时间**: `loginat`
- **注册IP**: `ip[]`
- **最后登录IP**: `loginip`
- **权限**: `priv`

### 9.2 域用户信息 (domain.user)
- **显示名称**: `displayName`
- **学号**: `studentId`
- **学校**: `school`
- **头像**: `avatar`

### 可提炼的数据指标：
- ✅ 注册时间分析
- ✅ 登录频率
- ✅ 用户活跃度
- ✅ 用户画像

---

## 十、综合数据分析维度

### 10.1 学习行为分析
1. **提交行为**
   - 提交频率（每日/每周/每月）
   - 提交时间段分布
   - 提交间隔分析
   - 提交习惯（一次性提交 vs 多次尝试）

2. **题目解决模式**
   - 首次AC时间分析
   - 尝试次数分布
   - 题目难度提升轨迹
   - 知识点掌握进度

3. **代码质量**
   - 代码长度趋势
   - 运行效率提升
   - 内存优化能力
   - 代码风格一致性

### 10.2 学习效果分析
1. **能力评估**
   - AC率趋势
   - 错误类型分析
   - 题目难度分布
   - 知识点覆盖度

2. **进步轨迹**
   - 时间序列分析
   - 能力提升速度
   - 瓶颈识别
   - 学习曲线

### 10.3 学习偏好分析
1. **内容偏好**
   - 题目标签偏好
   - 难度偏好
   - 语言偏好
   - 比赛类型偏好

2. **时间偏好**
   - 活跃时间段
   - 学习时长
   - 学习频率

### 10.4 社交与竞争分析
1. **比赛表现**
   - 比赛参与度
   - 比赛排名趋势
   - 比赛类型偏好

2. **社区参与**
   - 讨论参与度（如果有）
   - 题目收藏行为

---

## 十一、数据收集建议

### 11.1 实时数据收集
- 监听 `record/judge` 事件，收集提交记录
- 监听 `document.status` 变化，收集题目状态
- 监听用户操作事件，收集行为数据

### 11.2 批量数据聚合
- 定期聚合历史数据
- 计算统计数据
- 生成数据快照

### 11.3 数据存储设计
- **student.analytics.records**: 原始事件记录
- **student.analytics.stats**: 聚合统计数据
- **student.analytics.snapshots**: 历史快照数据

---

## 十二、代码行数统计功能

### 12.1 实现的功能
已实现学生每周代码行数统计功能，包括：

1. **每周代码统计** (`getWeeklyCodeStats`)
   - 统计指定周数内的代码行数
   - 按 ISO 周数分组
   - 包含每周的总代码行数、提交数、不同题目数、平均行数

2. **总代码行数** (`getTotalCodeLines`)
   - 统计学生所有提交的总代码行数
   - 排除 pretest 和 generate 类型的提交

### 12.2 统计方法
- **代码行数计算**：按换行符（`\r?\n`）分割代码，计算总行数（包括空行）
- **时间范围**：使用 `_id`（ObjectId 时间戳）或 `judgeAt` 字段确定提交时间
- **周数计算**：使用 ISO 周数标准（ISO 8601）
- **数据过滤**：自动排除 pretest 和 generate 类型的提交

### 12.3 返回数据格式
```typescript
interface WeeklyCodeStats {
    year: number;              // 年份
    week: number;              // ISO 周数 (1-53)
    weekStart: Date;           // 周开始日期
    weekEnd: Date;             // 周结束日期
    totalLines: number;         // 总代码行数
    totalSubmissions: number;   // 总提交数
    uniqueProblems: number;     // 不同题目数
    averageLinesPerSubmission: number; // 平均每次提交的代码行数
}
```

### 12.4 使用示例
```typescript
// 获取最近 12 周的代码统计
const weeklyStats = await dataService.getWeeklyCodeStats(domainId, uid, 12);

// 获取总代码行数
const totalLines = await dataService.getTotalCodeLines(domainId, uid);
```

## 十三、数据可视化建议

### 13.1 个人数据面板
- 提交趋势图
- AC率趋势图
- **每周代码行数趋势图**（新增）
- 题目难度分布图
- 语言使用饼图
- 错误类型分布图
- 学习时间热力图

### 13.2 管理员数据面板
- 用户活跃度统计
- 题目热度分析
- 系统使用情况
- 学习效果评估
- **代码量统计**（新增）
- 异常行为检测

---

## 参考资源

- [Hydro 数据库结构文档](https://hydro.js.org/docs/Hydro/dev/db-layout)
- Hydro 源码: `packages/hydrooj/src/interface.ts`
- Hydro 源码: `packages/hydrooj/src/model/record.ts`
- Hydro 源码: `packages/hydrooj/src/model/document.ts`

