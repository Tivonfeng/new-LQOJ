{% set profileUrl = url('user_detail', { uid: handler.user._id }) if handler.user and handler.user._id else '#' %}
<div id="personal-floatball" class="personal-floatball hidden">
  <div class="personal-floatball__button" role="button" aria-label="个人信息悬浮球">
    <img id="personal-floatball-avatar" class="personal-floatball__avatar" src="{{ avatarUrl(handler.user.avatar, 56) if handler.user else '' }}" alt="用户头像" />
    <div class="personal-floatball__badge" id="personal-floatball-badge">0</div>
  </div>
  <div class="personal-floatball__card" id="personal-floatball-card">
    <div class="personal-floatball__card-header">
      <div>
        <div class="personal-floatball__name" id="personal-floatball-name">{{ handler.user.displayName or handler.user.uname if handler.user else '未登录' }}</div>
        <div class="personal-floatball__meta" id="personal-floatball-meta">加载中...</div>
      </div>
      <a class="personal-floatball__link" href="{{ profileUrl }}">个人主页</a>
    </div>
    <div class="personal-floatball__stats">
      <div class="personal-floatball__stat">
        <div class="personal-floatball__stat-label">绿旗币</div>
        <div class="personal-floatball__stat-value" id="personal-floatball-coins">--</div>
      </div>
      <div class="personal-floatball__stat">
        <div class="personal-floatball__stat-label">今日AC</div>
        <div class="personal-floatball__stat-value" id="personal-floatball-today">--</div>
      </div>
      <div class="personal-floatball__stat">
        <div class="personal-floatball__stat-label">RP</div>
        <div class="personal-floatball__stat-value" id="personal-floatball-rp">--</div>
      </div>
    </div>
  </div>
</div>

<style>
.personal-floatball {
    position: fixed;
    right: 24px;
    bottom: 24px;
    z-index: 1200;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 10px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
}
.personal-floatball.hidden { display: none; }
.personal-floatball__button {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 50%, #7c3aed 100%);
    box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: relative;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.personal-floatball__button:hover { transform: translateY(-2px); box-shadow: 0 14px 36px rgba(59, 130, 246, 0.38); }
.personal-floatball__avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid rgba(255, 255, 255, 0.6);
    background: #fff;
}
.personal-floatball__badge {
    position: absolute;
    bottom: -4px;
    right: -4px;
    background: #10b981;
    color: #fff;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 700;
    box-shadow: 0 6px 16px rgba(16, 185, 129, 0.25);
    min-width: 24px;
    text-align: center;
}
.personal-floatball__card {
    width: 280px;
    padding: 14px;
    border-radius: 16px;
    background: #0f172a;
    color: #e2e8f0;
    box-shadow: 0 20px 60px rgba(15, 23, 42, 0.35);
    border: 1px solid rgba(255, 255, 255, 0.08);
    display: none;
}
.personal-floatball.expanded .personal-floatball__card { display: block; }
.personal-floatball__card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
}
.personal-floatball__name { font-size: 16px; font-weight: 700; color: #f8fafc; }
.personal-floatball__meta { font-size: 12px; color: #94a3b8; }
.personal-floatball__link {
    font-size: 12px;
    color: #93c5fd;
    text-decoration: none;
}
.personal-floatball__link:hover { color: #bfdbfe; text-decoration: underline; }
.personal-floatball__stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-top: 12px;
}
.personal-floatball__stat {
    padding: 10px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.06);
    text-align: center;
}
.personal-floatball__stat-label { font-size: 12px; color: #cbd5e1; margin-bottom: 6px; }
.personal-floatball__stat-value { font-size: 16px; font-weight: 800; color: #fbbf24; }
@media (max-width: 640px) {
    .personal-floatball { right: 16px; bottom: 16px; }
    .personal-floatball__card { width: 240px; }
}
</style>

<script>
(() => {
  const root = document.getElementById('personal-floatball');
  if (!root) return;
  const stateKey = 'lqoj_personal_floatball_state';
  const api = '{{ url("homepage_personal_info") }}';
  const badgeEl = document.getElementById('personal-floatball-badge');
  const nameEl = document.getElementById('personal-floatball-name');
  const metaEl = document.getElementById('personal-floatball-meta');
  const coinsEl = document.getElementById('personal-floatball-coins');
  const todayEl = document.getElementById('personal-floatball-today');
  const rpEl = document.getElementById('personal-floatball-rp');
  const avatarEl = document.getElementById('personal-floatball-avatar');
  const cardEl = document.getElementById('personal-floatball-card');
  const buttonEl = root.querySelector('.personal-floatball__button');

  let expanded = (typeof localStorage !== 'undefined' && localStorage.getItem(stateKey)) !== 'collapsed';
  const setExpanded = (open) => {
    expanded = open;
    root.classList.toggle('expanded', open);
    if (typeof localStorage !== 'undefined') localStorage.setItem(stateKey, open ? 'open' : 'collapsed');
  };

  buttonEl?.addEventListener('click', (e) => {
    e.stopPropagation();
    setExpanded(!expanded);
  });

  document.addEventListener('click', (e) => {
    if (!root.contains(e.target)) setExpanded(false);
  });

  const safeText = (el, text) => { if (el) el.textContent = text; };
  const hide = () => root.classList.add('hidden');

  fetch(api, { credentials: 'include' })
    .then((r) => r.json())
    .then((res) => {
      if (!res?.loggedIn || !res.user) return hide();
      const user = res.user;
      safeText(nameEl, user.displayName || user.uname || '用户');
      safeText(metaEl, `UID ${user.uid}`);
      safeText(coinsEl, user.greenFlagCoins ?? 0);
      safeText(todayEl, user.todayAccept ?? 0);
      safeText(rpEl, user.rp ?? 0);
      safeText(badgeEl, user.todayAccept ?? 0);
      if (avatarEl && (user.avatarUrl || user.avatar)) avatarEl.src = user.avatarUrl || user.avatar;
      root.classList.remove('hidden');
      if (expanded) setExpanded(true);
    })
    .catch(hide);
})();
</script>

