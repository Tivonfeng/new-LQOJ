{% extends "layout/basic.html" %}

{% block content %}
<div id="score-manage-react-app"></div>

<!-- React组件将处理所有JavaScript功能 -->

<!-- 域信息传递给前端 -->
<script>
// 设置全局域信息和URL信息供React组件使用
window.ScoreSystemDomain = {
  id: '{{ currentDomain.id }}',
  name: '{{ currentDomain.name }}',
  displayName: '{{ currentDomain.displayName }}'
};

window.ScoreSystemConfig = {
  submitUrl: '{{ url("score_manage") }}',
  currentPath: '{{ handler.request.path }}',
  domainId: '{{ handler.domain._id }}'
};

{# 安全回退 #}
{% set recent = recentRecords or [] %}
// 最近积分记录数据（前端分页）
window.ScoreManageRecentRecords = {
  records: [
    {% for record in recent %}
    {
      uid: '{{ record.uid|escape }}',
      score: {{ record.score or 0 }},
      pid: {{ record.pid or 0 }},
      category: '{{ record.category|default("", true)|escape }}',
      title: '{{ record.title|default("", true)|escape }}',
      reason: '{{ record.reason|default("", true)|escape }}',
      createdAt: '{{ record.createdAt|string|escape }}'
    }{{ "," if not loop.last else "" }}
    {% endfor %}
  ],
  users: {
    {% if udocs %}
      {% for uid, user in udocs %}
      '{{ uid|escape }}': {
        uname: '{{ user.uname|default("", true)|escape }}',
        displayName: '{{ user.displayName|default("", true)|escape }}'
      }{{ "," if not loop.last else "" }}
      {% endfor %}
    {% endif %}
  }
};

</script>

{% endblock %}
