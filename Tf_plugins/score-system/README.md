# 积分系统插件 (Score System Plugin)

一个为 Hydro OJ 开发的积分系统插件，当学生成功 AC（Accepted）题目时自动给予积分奖励。

## 功能特性

- **自动积分奖励**：学生AC题目后自动获得积分
- **难度加成**：根据题目难度调整积分倍数
- **首次AC奖励**：首次AC的题目有额外奖励
- **积分排行榜**：显示所有用户的积分排名
- **个人积分页面**：用户可查看自己的积分和历史记录
- **管理界面**：管理员可查看积分系统统计信息
- **可配置系统**：支持通过配置文件调整积分规则

## 安装方法

1. 将插件文件放置到 `Tf_plugins/score-system/` 目录
2. 重启 Hydro 服务
3. 插件会自动加载并开始工作

## 配置选项

插件支持以下配置选项（通过 Hydro 的配置系统设置）：

```yaml
score-system:
  enabled: true              # 是否启用积分系统
  baseScore: 10              # 基础AC积分
  firstACBonus: 5            # 首次AC额外奖励
  difficultyMultiplier:      # 难度倍数
    "1": 1                   # 难度1倍数
    "2": 1.2                 # 难度2倍数
    "3": 1.5                 # 难度3倍数
    "4": 2                   # 难度4倍数
    "5": 3                   # 难度5倍数
```

## 页面路由

插件提供以下页面：

- `/score/hall` - **积分大厅**（主要入口，包含个人概览、排行榜、积分商城预览）
- `/score/manage` - 积分系统管理页面（需要系统管理权限）
- `/score/ranking` - 积分排行榜（完整分页版本）
- `/score/me` - 个人积分详细页面

## 导航栏集成

插件会自动在顶部导航栏添加"积分大厅"菜单项，位置在"排行榜"之前。所有用户都可以访问积分大厅页面。

## 数据库集合

插件创建以下 MongoDB 集合：

- `score.records` - 积分记录
- `score.users` - 用户积分汇总

## 积分计算规则

1. **基础积分**：每次AC获得基础积分（默认10分）
2. **难度加成**：根据题目难度乘以对应倍数
3. **首次AC奖励**：第一次AC某题时额外获得奖励分（默认5分）
4. **去重机制**：同一题目多次AC不会重复得分

**计算公式**：
```
最终积分 = (基础积分 × 难度倍数) + (首次AC ? 首次AC奖励 : 0)
```

## 事件监听

插件监听 `record/judge` 事件，当判题完成且状态为 AC 时触发积分计算。

## 权限要求

- 查看个人积分：需要登录
- 管理积分系统：需要 `PRIV_EDIT_SYSTEM` 权限

## 开发说明

### 文件结构
```
score-system/
├── package.json           # 插件配置
├── index.ts              # 主逻辑文件
├── templates/            # HTML模板
│   ├── score_manage.html
│   └── user_score.html
├── locales/              # 国际化文件
│   ├── en.yaml
│   └── zh.yaml
└── README.md             # 说明文档
```

### 主要类和方法

- `ScoreService` - 积分计算和数据操作服务
- `ScoreManageHandler` - 管理页面处理器
- `UserScoreHandler` - 个人积分页面处理器

## 故障排除

1. **积分没有更新**
   - 检查插件是否正确加载
   - 确认配置中 `enabled: true`
   - 检查题目是否真的AC了

2. **页面显示异常**
   - 确认模板文件存在
   - 检查数据库连接是否正常

3. **权限问题**
   - 确认用户有足够权限访问对应页面
   - 检查登录状态

## 更新日志

### v1.0.0
- 初始版本发布
- 支持基本的AC积分功能
- 提供管理界面和排行榜
- 支持中英文国际化

## 许可证

本插件采用 AGPL-3.0 许可证。